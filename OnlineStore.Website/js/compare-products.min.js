$(function(){function v(){$(".rate").raty({half:!0,readOnly:!0,score:function(){return $(this).attr("data-score")}})}function y(t){var i,r;for(o=[],i=0;i<t.length;i++)r=t,o.push({Value:r[i].Value,ID:r[i].ID,Perfix:r[i].Perfix,Posfix:r[i].Posfix});u.each(function(){var r=$(this),u=r.data("id"),i="",t;typeof u!="undefined"&&(t=_.find(o,function(n){return u==n.ID}),t.Value!=null&&t.Value!=""&&(t.Perfix!=null&&(i+=t.Perfix+" "),i+=t.Value,t.Posfix!=null&&(i+=" "+t.Posfix)),r.append('<td data-id="'+n+'">'+i+"<\/td>"))})}function p(t){for(var r,f=$("<ul />"),e=$('<td data-id="'+n+'" />'),i=0;i<t.length;i++)r=t,f.append("<li><span>"+r[i].Title+"<\/span>:<span>"+r[i].Average+"<\/span><\/li>");u.filter(":nth-child(2)").append(e.append(f))}function w(){var e=_.find(t,function(t){return t==n}),i;if(typeof e!="undefined"){toastr.warning("محصول مورد نظر در لیست موجود است!","مقایسه کالا");r.val("").removeAttr("disabled");return}if(t.length>=5){toastr.error("مقایسه ی بیش از 5 محصول امکان پذیر نمی باشد!","مقایسه کالا");r.val("").removeAttr("disabled");return}i=$(staticTemplates.Loading);h.append(i);t.push(n);$.ajax({type:"POST",url:"/CompareProducts/AddToCompare",data:{GroupID:mainGroupID,newProductID:n},success:function(t){var i,r,e;t.Success&&(i=t.Data,f.children(":nth-child(1)").append('<td data-id="'+n+'"><a title="'+i.ToolTip+'" href="'+i.Url+'"><div class="product-detail"><img src="'+i.Image+'" /><span class="title">'+i.DisplayTitle+'<\/span><a class="fa fa-times-circle"><\/a><\/div><\/a><\/td>'),r='<a data-score="'+i.Score+'" class="rate"><\/a><span class="preferentials">( از '+i.PreferentialsCount+" رأی )<\/span>",u.filter(":nth-child(1)").append('<td class="score" data-id="'+n+'">'+r+"<\/td>"),e=b(i),u.filter(":nth-child(3)").append('<td data-id="'+n+'">'+e+"<\/td>"),i.Attributes.length>0&&y(i.Attributes),p(i.ScoresAverages))},error:function(){alert("خطا")},complete:function(){i.remove();v();s();r.val("");$(window).resize();c()}})}function s(){f.find(".ts-row-fixed").remove();$(document).tableSection()}function b(n){var i=n.Prices,t=undefined,r=undefined;return n.IsUnavailable?result="<div class='price-isunavailable'><i class='fa fa-times-circle'><\/i> موجود نیست<\/div>":(i!=null&&i.length>0&&(t=i[0],r=i[i.length-1]),result=t?t.DiscountPercent>0?"<div class='original-price'><span>"+toPrice(t.Price,"{0}{1}")+"<\/span><\/div><div class='topay-price'><span>"+toPrice(t.DiscountPrice,"{0}{1}")+"<\/span><\/div>":"<div class='regular-price'><span>"+toPrice(t.Price,"{0}{1}")+"<\/span><\/div>":"<div class='regular-price'><span>"+toPrice(0,"{0}{1}")+"<\/span><\/div>"),result}function c(){$(".score .rate").raty({half:!0,readOnly:!1,score:function(){return $(this).attr("data-score")},click:function(n){var t=$(this),i=$(staticTemplates.Loading),u=t.closest(".score"),r;u.append(i);r=t.closest("td").data("id");$.ajax({type:"POST",url:"/Products/InsertRate",data:{ProductID:r,Rate:n},success:function(n){n.Success?toastr.success("با تشکر از امتیاز شما","امتیازدهی"):n.Errors[0]=="Repeat"&&toastr.error("قبلا برای این محصول امتیاز ثبت کرده اید! ","امتیازدهی")},error:function(){toastr.error(staticTexts.RequestError,"امتیازدهی")},complete:function(){i.remove()}})}})}var r=$(".search-box #Search"),l=$(".search-box"),i=$(".search-box .result-box"),k=$(".search-box .not-found"),h=$(".product-compare"),a=$("#ProductIDs"),u=$(".product-compare table tbody tr"),f=$(".product-compare table thead"),n=-1,o=[],t=a.val().split(","),e;s();c();e=undefined;r.bind("keyup paste",function(){e&&clearTimeout(e);r.val().trim().length>1?e=setTimeout(function(){var n=$(staticTemplates.Loading);l.append(n);$.ajax({type:"POST",url:"/CompareProducts/Search",data:{GroupID:mainGroupID,Key:r.val()},success:function(n){var u,r,t,f;if(n.Success)if(n.Data.length==0)i.html('<span class="not-found">موردی یافت نشد.<\/span>');else{for(i.empty(),u=$("<ul>"),r=0;r<n.Data.length;r++)t=n.Data[r],f='<li><a href="#" data-id="'+t.ID+'" title="'+t.DisplayTitle+'"><img src="'+t.Image+'"><div class="title-box"><p>'+t.Title_En+"<\/p><p>"+t.Title_Fa+"<\/p><\/div><\/a><\/li>",u.append(f);i.append(u)}else alert("خطا")},error:function(){},complete:function(){n.remove();i.slideDown()}})},800):i.slideUp()});i.on("click","a",function(r){var f,e,u;r.preventDefault();f=$(this);i.hide();n=f.data("id");w();e={};u="http://online-store.com/CompareProducts/";u=u+t.join(",");history.pushState(e,"",u)});f.on("click",".fa-times-circle",function(){var r,e,n,o,i;if(t.length<=1){toastr.warning("حذف محصول امکان پذیر نمی باشد!","مقایسه کالا");return}r=$(staticTemplates.Loading);h.append(r);e=$(this);n=e.closest("td").data("id");u.find('td[data-id="'+n+'"]').remove();f.find('td[data-id="'+n+'"]').remove();t=_.filter(t,function(t){return t!=n});r.remove();s();o={};i="http://online-store.com/CompareProducts/";i=i+t.join(",");history.pushState(o,"",i);$(window).resize()})});